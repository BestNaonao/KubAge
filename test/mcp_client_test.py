import asyncio
import sys
import os
from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

# ç¡®ä¿è¿™é‡Œçš„åå­—ä¸ä½ çš„æœåŠ¡å™¨æ–‡ä»¶åä¸€è‡´
SERVER_SCRIPT = "../os_mcp/os_mcp_server.py"


async def run_tests():
    # 1. é…ç½®æœåŠ¡å™¨å¯åŠ¨å‚æ•°
    # æˆ‘ä»¬å°† python è§£é‡Šå™¨ä½œä¸ºå‘½ä»¤ï¼ŒæœåŠ¡å™¨è„šæœ¬ä½œä¸ºå‚æ•°
    server_params = StdioServerParameters(
        command=sys.executable,
        args=[SERVER_SCRIPT],
        env=None  # å¯ä»¥ç»§æ‰¿å½“å‰ç¯å¢ƒå˜é‡
    )

    print(f"ğŸ”Œ Connecting to MCP Server: {SERVER_SCRIPT} ...")

    # å»ºç«‹ stdio è¿æ¥
    async with stdio_client(server_params) as (read, write):
        async with ClientSession(read, write) as session:
            # åˆå§‹åŒ–æ¡æ‰‹
            await session.initialize()
            print("âœ… Connected and Initialized!\n")

            # --- å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥æ¨¡æ‹Ÿ 'tool.invoke' ---
            async def invoke_tool(tool_name: str, args: dict):
                print(f"ğŸ› ï¸  Invoking: [ {tool_name} ]")
                print(f"   Args: {args}")
                try:
                    # è¿™å°±æ˜¯æ ‡å‡†çš„å¼‚æ­¥è°ƒç”¨æ–¹å¼ï¼Œç­‰åŒäº await tool.coroutine(**args)
                    result = await session.call_tool(tool_name, arguments=args)

                    # æå–æ–‡æœ¬å†…å®¹
                    output = result.content[0].text
                    print(f"   Example Output: {output[:1000]}..." if len(output) > 1000 else f"   Result: {output}")
                    print("   âœ… Success\n")
                    return output
                except Exception as e:
                    print(f"   âŒ Failed: {e}\n")

            # ==========================================
            # å¼€å§‹æµ‹è¯• 5 ä¸ªå·¥å…·
            # ==========================================
            tools = await session.list_tools()
            for tool in tools.tools:
                print(f"Name: {tool.name},")
                print(f"  -Description: {tool.description}")
                print(f"  -InputSchema: {tool.inputSchema}")


            # 1. æµ‹è¯• get_system_info
            # è¿™é‡Œçš„ç›®çš„æ˜¯è·å–ç¯å¢ƒåŸºç¡€ä¿¡æ¯
            await invoke_tool("get_system_info", {})

            # 2. æµ‹è¯• write_file
            # æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªæ–‡ä»¶ï¼Œä¾›åç»­è¯»å–æµ‹è¯•
            test_filename = "mcp_test_doc.txt"
            test_content = "Hello! This is a test content generated by the Async MCP Client.\nTime to test I/O."
            await invoke_tool("write_file", {
                "path": test_filename,
                "content": test_content
            })

            # 3. æµ‹è¯• read_file
            # è¯»å–åˆšæ‰å†™å…¥çš„æ–‡ä»¶ï¼ŒéªŒè¯å†…å®¹
            read_result = await invoke_tool("read_file", {
                "path": test_filename
            })
            # ç®€å•æ–­è¨€éªŒè¯
            if "Async MCP Client" not in read_result:
                print("   âš ï¸  Warning: File content mismatch!")

            # 4. æµ‹è¯• append_environment_variable
            # å‘ .env æ–‡ä»¶è¿½åŠ å˜é‡
            await invoke_tool("append_environment_variable", {
                "key": "DEPLOY_ENV",
                "value": "staging_v2"
            })

            # 5. æµ‹è¯• execute_command
            # ä½¿ç”¨ echo å‘½ä»¤éªŒè¯å‘½ä»¤æ‰§è¡Œ (è·¨å¹³å°å…¼å®¹)
            # æ³¨æ„ï¼šç”±äºæˆ‘ä»¬åœ¨æœåŠ¡ç«¯ä½¿ç”¨äº† shlexï¼Œä¸è¦ä½¿ç”¨å¤æ‚çš„ç®¡é“ç¬¦
            await invoke_tool("execute_command", {
                "command": "powershell echo 'å¥½å¥½å¥½ï¼ŒMCP Command Execution Works'"
            })

            await invoke_tool("execute_command", {
                "command": "ollama list"
            })
            await invoke_tool("execute_command", {
                "command": "python -V"
            })
            # é¢å¤–æµ‹è¯•ï¼šæµ‹è¯• execute_command çš„è¶…æ—¶æˆ–é”™è¯¯å¤„ç† (å¯é€‰)
            await invoke_tool("execute_command", {
                "command": "powershell sleep 2",
                "timeout": 1
            })



    print("ğŸ All tests completed.")


if __name__ == "__main__":
    # æ£€æŸ¥æœåŠ¡å™¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(SERVER_SCRIPT):
        print(f"âŒ Error: Server file '{SERVER_SCRIPT}' not found in current directory.")
        sys.exit(1)

    # è¿è¡Œå¼‚æ­¥ä¸»å¾ªç¯
    try:
        asyncio.run(run_tests())
    except KeyboardInterrupt:
        print("\nClient stopped by user.")